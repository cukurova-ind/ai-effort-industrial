{% extends "main_template.html" %}
{% load static %}

{% block title %}

Veri seti

{% endblock %}


{% block content %}
<div class="container-fluid data-settings">
    
    

    <div class="container-fluid main-container">

        <div class="container-fluid d-flex justify-content-between align-items-center mb-3 top-container">
            <div class="text-start">
                <h2 class="mb-0">Ayarlar</h2>
                {% if using_custom_csv %}
                <small class="text-warning"><i class="fas fa-file-csv"></i> Özel CSV verisi kullanılıyor</small>
                {% endif %}
            </div>
            <div class="text-end">
                <strong>{{ profile_name|default:'unknownprofile' }}</strong>
                {% if profile_name %}
                            
                    <script>
                        window.addEventListener('load', function () {
                            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                        });
                    </script>
                    
                {% endif %}
            </div>
        </div>
        <hr>

        <!-- Fixed Side Panel -->
        <div class="side-panel">
            <div>
                <h5 class="mb-2">Kayıtlı Profiller</h5>
                <div class="d-flex flex-column gap-2">
                    {% for profile in profiles %}
                        <a href="{% url 'data_settings_with_profile' profile %}" class="text-decoration-none text-dark text-italic">
                            {{ profile }}
                        </a>
                    {% empty %}
                        <div class="text-muted">Kayıtlı profil yok</div>
                    {% endfor %}
                </div>
            </div>
            <div class="sidebar-buttons-section">
                <!-- CSV Upload Section - Always Available -->
                <div class="mb-3 border rounded p-2" style="background-color: #f8f9fa;">
                    <h6 class="mb-2 text-muted">Veri Kaynağı</h6>
                    {% if using_custom_csv %}
                        <div class="alert alert-info alert-sm p-2 mb-2" role="alert">
                            <small><i class="bi bi-file-earmark-text"></i> CSV dosyası kullanılıyor</small>
                        </div>
                    {% endif %}
                    {% if random_state_message %}
                        <div class="alert alert-info alert-sm p-2 mb-2" role="alert">
                            <small><i class="bi bi-shuffle"></i> {{ random_state_message }}</small>
                        </div>
                    {% endif %}
                    <button class="btn btn-info btn-sm w-100 mb-2" id="csvUpload" type="button" data-bs-toggle="modal" data-bs-target="#csvUploadModal">
                        <i class="bi bi-upload"></i> CSV Yükle
                    </button>
                    {% if using_custom_csv %}
                    <a href="{% url 'clear_csv' %}" class="btn btn-outline-warning btn-sm w-100 mb-2">
                        <i class="bi bi-arrow-counterclockwise"></i> Normal Veriye Dön
                    </a>
                    {% endif %}
                </div>
                
                <!-- Profile Management Section -->
                <div class="mb-3">
                    <button class="btn btn-success btn-sm w-100 mb-2" id="saveUpdate" type="button" disabled=true>Kaydet / Güncelle</button>
                    <button class="btn btn-warning btn-sm w-100 mb-2" id="saveAs" type="button" disabled=true>Farklı Kaydet</button>
                    {% if profile_name %}
                    <a href="{% url 'profile_delete' profile_name %}" class="btn btn-danger btn-sm w-100 mb-2">
                        Sil
                    </a>
                    {% endif %}
                </div>
                <div class="mb-3">
                    <button class="btn btn-primary btn-sm w-100 mb-2" id="skip" 
                    type="button" {% if profile_name %}{% else %}disabled{% endif %}>Devam</button>
                    <button class="btn btn-secondary btn-sm w-100 mb-2" id="noSave" type="button" 
                    disabled=true>Kaydetmeden Devam</button>
                    
                    <p class="text-center text-danger small" id="err"></p>
                    <div id="namePrompt" style="display: none;">
                        <div class="mb-2">
                            <label for="newProfileName" class="form-label small">Profil ismi girin:</label>
                            <input type="text" id="newProfileName" name="newProfileName" class="form-control form-control-sm">
                        </div>
                    </div>
                </div>
            </div>
            <div class="logout-bottom mt-3">
                <a href="{% url 'custom_logout' %}" class="btn btn-outline-danger w-100">Çıkış Yap</a>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            {% if no_data %}
                <!-- No Data Available Message -->
                <div class="alert alert-warning" role="alert">
                    <h4 class="alert-heading">No Data Available</h4>
                    <p>{{ message }}</p>
                    <hr>
                    <p class="mb-0">To get started, you can either:</p>
                    <ul class="mt-2">
                        <li><strong>Upload your own CSV file</strong> using the "CSV Yükle" button in the sidebar</li>
                        <li>Or add data to the database:
                            <ul>
                                <li>Add some experiments to the database</li>
                                <li>Add input data (fabrics and their properties)</li>
                                <li>Add recipes for processing</li>
                                <li>Link them together through the data operations interface</li>
                            </ul>
                        </li>
                    </ul>
                    <div class="mt-3">
                        <a href="/dataops/" class="btn btn-primary">Go to Data Operations</a>
                        <a href="/modeling/" class="btn btn-secondary">Back to Modeling</a>
                    </div>
                </div>
            {% else %}
                <!-- Normal Configuration Form -->
                <form method="post" id="settingsForm">
                    {% csrf_token %}
                        <div class="text-start">
                            <p class="mb-0"><strong>1. Girdi Değişkenleri</strong></p>
                        </div>
                        <hr>
                        <div class="table-container">

                            <div class="scroll-container border rounded">

                                <table id="inputTable" class="table table-bordered table-hover table-striped table-fixed align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            {% for col in columns %}
                                            <th>
                                                <input class="form-check-input input_columns" type="checkbox"
                                                    id="inp_{{ col.column }}" data-label="{{ col.label }}"
                                                    name="inp_{{ col.column }}" value="{{ col.column }}" 
                                                    {% if col.input_checked %}checked{% endif %}>
                                                <label for="inp_{{ col.column }}" class="form-label">&nbsp;{{ col.label }}</label>
                                                <p>{{ col.attr_type }}</p>
                                                <p>{{ col.d_type }}</p>
                                                {% if col.attr_type == 'categorical' %}
                                                    <div class="categoryFilter">
                                                        <select id="filter_values_{{ col.column }}" name="filter_values_{{ col.column }}"
                                                         class="form-select" data-column="{{ col.column }}">
                                                            <option value="*">*</option>
                                                            {% for option in col.options %}
                                                                <option value="{{ option }}"
                                                                 {% if col.value_filter == option %}selected{% endif %} >{{ option }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                {% else %}
                                                    <div class="minFilter">
                                                        <input class="form-control" type="number"
                                                        id="filter_min_{{ col.column }}" placeholder="büyük eşittir"
                                                        name="filter_min_{{ col.column }}"
                                                        value="{{ col.min_filter }}">
                                                    </div>
                                                    <div class="maxFilter">
                                                        <input class="form-control" type="number"
                                                        id="filter_max_{{ col.column }}" placeholder="küçük eşittir"
                                                        name="filter_max_{{ col.column }}"
                                                        value="{{ col.max_filter }}">
                                                    </div>
                                                {% endif %}
                                            </th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in rows %}
                                        <tr>
                                            {% for r in row %}
                                            <td>{{ r }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    <div class="buttons-container">
                        <button type="button" id="checkAllBtn" class="btn btn-sm btn-primary me-2">Hepsini Seç</button>
                        <button type="button" id="uncheckAllBtn" class="btn btn-sm btn-secondary">Hepsini Kaldır</button>
                    </div>
                    <label for="id_selection" class="form-label">Seçilenler</label>
                <input class="form-control" type="text" id="id_selection" name="input_list" value="" readonly>
                <hr>
                <div class="text-start">
                    <p class="mb-0"><strong>2. Çıktı Değişkenleri</strong></p>
                </div>
                <hr>
                <div class="table-container">

                    <div class="scroll-container border rounded">

                        <table id="targetTable" class="table table-bordered table-hover table-striped table-fixed align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    {% for col in columns %}
                                    <th>
                                        <input class="form-check-input output_columns" type="checkbox"
                                            id="id_{{ col.column }}" name="out_{{ col.column }}"
                                            data-label="{{ col.label }}" value="{{ col.column }}"
                                            {% if col.target_checked %}checked{% endif %}>
                                        <label for="id_{{ col.column }}" class="form-label">&nbsp;{{ col.label }}</label>
                                        <p>{{ col.attr_type }}</p>
                                        <p>{{ col.d_type }}</p>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in rows %}
                                <tr>
                                    {% for r in row %}
                                    <td>{{ r }}</td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                    </div>
                </div>
                <label for="id_selection_output" class="form-label">Seçilenler</label>
                <input class="form-control" type="text" id="id_selection_output" name="output_list" value="" readonly>
                <hr>

                <hr>
                <div class="text-start">
                    <p class="mb-0"><strong>3. Veri Bölümleme (Optional)</strong></p>
                </div>
                <hr>

                <div class="mb-3 row">
                    <div class="col-md-9">
                        <label for="test_size" class="form-label">Test Size [0, 0.9]</label>
                        <input name="test_size" type="number" min="0" max="0.9" step="0.05" class="form-control"
                            id="test_size" value="{% if conf.test_size %}{{ conf.test_size }}{% else %}0.0{% endif %}">
                    </div>
                    <div class="col-md-3">
                        <label for="random_state" class="form-label">Random State</label>
                        <input name="random_state" type="number" min="0" max="1111" step="1" class="form-control"
                            id="random_state" value="{% if conf.random_state %}{{ conf.random_state }}{% else %}0{% endif %}"
                            title="Pozitif tamsayı girin. Aynı sonuçları tekrarlamak için kullanılır.">
                        <small class="form-text text-muted">0 veya pozitif değer: tekrarlanabilir sonuçlar</small>
                    </div>
                </div>

                <hr>
                <div class="text-start">
                    <p class="mb-0"><strong>4. Değişken Ölçekleme (Sadece Girdiler) (Optional)</strong></p>
                </div>
                <hr>

                <div class="mb-3 row">
                    <div class="col-md-12">
                        <label for="scale" class="form-label">Ölçekleme</label>
                        <select name="input_scaling" class="form-select">
                            {% if conf.input_scaling == "norm1" %}
                            <option value="norm1" selected>Normalizasyon [0,1]</option>
                            {% else %}
                            <option value="norm1">Normalizasyon [0,1]</option>
                            {% endif %}

                            {% if conf.input_scaling == "norm2" %}
                            <option value="norm2" selected>Normalizasyon [-1,1]</option>
                            {% else %}
                            <option value="norm2">Normalizasyon [-1,1]</option>
                            {% endif %}

                            {% if conf.input_scaling == "off" %}
                            <option value="off" selected>Yok</option>
                            {% else %}
                            <option value="off">Yok</option>
                            {% endif %}

                        </select>
                    </div>
                </div>

                <hr>
                <div class="text-start">
                    <p class="mb-0"><strong>5. Eğitim Ayarları</strong></p>
                </div>
                <hr>
                
                <div class="mb-3 row">
                    <div class="col-md-6">
                        <label for="model_type" class="form-label">Model Tipi</label>
                        <select name="model" class="form-select" id="model_type">

                            {% if conf.model_type == "mlp" %}
                            <option value="mlp" selected>Multilayer Perceptron</option>
                            {% else %}
                            <option value="mlp">Multilayer Perceptron</option>
                            {% endif %}

                            {% if conf.model_type == "ml" %}
                            <option value="ml" selected>Machine Learning Collection</option>
                            {% else %}
                            <option value="ml">Machine Learning Collection</option>
                            {% endif %}

                            {% if conf.model_type == "cnnmlp" %}
                            <option value="cnnmlp" selected>Multimodal MLP</option>
                            {% else %}
                            <option value="cnnmlp">Multimodal MLP</option>
                            {% endif %}

                            {% if conf.model_type == "simple_gan" %}
                            <option value="simple_gan" selected>Simple Text-To-Gan</option>
                            {% else %}
                            <option value="simple_gan">Simple Text-To-Gan</option>
                            {% endif %}

                        </select>
                    </div>

                    <div class="col-md-2">
                        <div class="form-check form-switch py-3" id="re-train">
                            <input class="form-check-input" type="checkbox" role="switch" id="retrain" name="retrain"
                            {% if conf.retrain == 'on' %}checked{% endif %}>
                            <label for="retrain" class="form-label">Yeniden Eğitim?</label>
                        </div>

                    </div>

                    <div class="col-md-4">

                        <label for="saved_model" class="form-label">Kayıtlı Model</label>
                        <select name="saved_model" class="form-select" id="saved_model" disabled>
                            {% if conf.retraining_model_name %}
                            <option value="{{ conf.retraining_model_name }}">{{ conf.retraining_model_name }}</option>
                            {% endif %}
                        </select>
                    </div>
                </div>

                <div class="mb-3 row">

                    <div class="col-md-3">
                        <label for="batch" class="form-label">Veri Seti Batch Büyüklüğü</label>
                        <input name="batch_size" type="number" class="form-control" id="batch"
                        min="4" max="256" step="4" 
                        value="{% if conf.batch_size %}{{ conf.batch_size }}{% else %}16{% endif %}">
                    </div>

                    <div class="col-md-3">
                        <label for="epoch" class="form-label">Training Epoch Sayısı</label>
                        <input name="n_epoch" type="number" class="form-control" id="epoch"
                        min="1" max="10000" step="1" 
                        value="{% if conf.n_epoch %}{{ conf.n_epoch }}{% else %}1{% endif %}">
                    </div>

                    <div class="col-md-3">
                        <label for="loss_function" class="form-label">Hata Fonksiyonu</label>
                        <select name="loss_function" class="form-select" id="loss_function">

                            <option value="mse" {% if conf.loss_function == 'mse' %}selected{% endif %}>Mean Squared Error (MSE)</option>
                            <option value="mae" {% if conf.loss_function == 'mae' %}selected{% endif %}>Mean Absolute Error (MAE)</option>
                            <option value="mape" {% if conf.loss_function == 'mape' %}selected{% endif %}>Mean Absolute Percentage Error (MAPE)</option>

                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="learning_rate" class="form-label">Öğrenme Oranı (AdaM)</label>
                        <input name="learning_rate" type="number" class="form-control" id="learning_rate" 
                        min="0.0000001" max="0.1" step="0.001"
                        value="{% if conf.learning_rate %}{{ conf.learning_rate }}{% else %}0.001{% endif %}">
                    </div>

                </div>

                <div class="mb-3 row">

                    <label for="batch" class="form-label">Validasyon Bölümü (Eğitim Setinden)</label>
                    <div class="col-md-2">

                        <input class="form-check-input" type="checkbox" id="single_val"
                            name="single_val" {% if conf.single_shot_validation == 'on' %}checked{% endif %}>
                        <label for="single_val" class="form-label">Her epoch sabit</label>

                    </div>

                    <div class="col-md-2">

                        <label for="val_size" class="form-label">Val Size [0, 0.5]</label>
                        <input name="val_size" type="number" min="0" max="0.5" step="0.05" class="form-control"
                            id="val_size" value="{% if conf.val_size %}{{ conf.val_size }}{% else %}0.0{% endif %}">

                    </div>

                </div>
                <input type="hidden" id="currentProfile" name="currentProfileName" value="{{ profile_name|default:'unknownprofile' }}">
            </form>
            {% endif %}
        </div>
    </div>
</div>

<!-- CSV Upload Modal -->
<div class="modal fade" id="csvUploadModal" tabindex="-1" aria-labelledby="csvUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="csvUploadModalLabel">
                    <i class="bi bi-upload"></i> CSV Dosyası Yükle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="csvUploadForm" method="post" enctype="multipart/form-data" action="{% url 'csv_upload' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-primary" role="alert">
                        <h6 class="alert-heading"><i class="bi bi-info-circle"></i> Kendi Verinizi Kullanın!</h6>
                        <p class="mb-0">Bu özellik sayesinde kendi CSV dosyanızı yükleyerek modeling sistemini test edebilirsiniz. 
                        Veritabanındaki veriler değişmez, sadece geçici olarak sizin verileriniz kullanılır.</p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="csvFile" class="form-label"><strong>CSV Dosyası Seçin</strong></label>
                        <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                        <div class="form-text">
                            <i class="bi bi-exclamation-triangle text-warning"></i> 
                            Maksimum dosya boyutu: 2MB | Desteklenen format: .csv
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hasHeaders" name="has_headers" checked>
                            <label class="form-check-label" for="hasHeaders">
                                <strong>Dosya sütun başlıkları içeriyor</strong>
                            </label>
                            <div class="form-text">İlk satır sütun adları olarak kullanılacaktır</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-success" role="alert">
                                <small><strong>Avantajlar:</strong></small>
                                <ul class="mb-0 mt-1">
                                    <li><small>Hızlı test imkanı</small></li>
                                    <li><small>Kendi verilerinizle deneme</small></li>
                                    <li><small>Veritabanı etkilenmez</small></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning" role="alert">
                                <small><strong>Önemli Not:</strong></small>
                                <ul class="mb-0 mt-1">
                                    <li><small>Veriler geçici olarak saklanır</small></li>
                                    <li><small>Profil "(custom)" eki ile kaydedilir</small></li>
                                    <li><small>2 saat sonra otomatik silinir</small></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-upload"></i> Yükle ve Analiz Et
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Check file size (2MB limit)
        if (file.size > 2 * 1024 * 1024) {
            alert('Dosya boyutu 2MB\'dan büyük olamaz.');
            e.target.value = '';
            return;
        }
        
        // Check file extension
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('Sadece CSV dosyaları kabul edilir.');
            e.target.value = '';
            return;
        }
    }
});
</script>

{% endblock %}